#!/bin/bash

# Configuration
CONFIG_DIR="$HOME/.config/omarchy/workspace-bg"
CONFIG_FILE="$CONFIG_DIR/config.conf"
DAEMON_NAME="omarchy-workspace-bg-daemon"

# Ensure config directory exists
mkdir -p "$CONFIG_DIR"
touch "$CONFIG_FILE"

# Colors and Styles
HEADER_STYLE="gum style --foreground 212 --border-foreground 212 --border double --align center --width 50 --margin \"1 2\" --padding \"2 4\""
ITEM_STYLE="gum style --foreground 212"

# Helper function to header
show_header() {
    clear
    echo "Omarchy Workspace Backgrounds" | $HEADER_STYLE
}

# Helper to reload daemon
reload_daemon() {
    if pgrep -f "$DAEMON_NAME" > /dev/null; then
        # If installed in path
        if command -v "$DAEMON_NAME" &> /dev/null; then
            "$DAEMON_NAME" --reload
        else
            # Try to find it relative to this script if running from source/bin
            SCRIPT_DIR=$(dirname "$(readlink -f "$0")")
            if [ -x "$SCRIPT_DIR/$DAEMON_NAME" ]; then
                "$SCRIPT_DIR/$DAEMON_NAME" --reload
            fi
        fi
        gum style --foreground 76 "✓ Daemon reloaded"
    else
        gum style --foreground 196 "✗ Daemon not running"
    fi
}

configure_all_workspaces() {
    echo "Configure All Workspaces (1-10)"
    echo "This will guide you through setting a wallpaper for each workspace sequentially."

    if ! gum confirm "Are you ready to start?"; then
        return
    fi

    # Loop from 1 to 10
    for WS_ID in {1..10}; do
        clear
        echo "Omarchy Workspace Backgrounds" | $HEADER_STYLE
        echo "Selecting wallpaper for Workspace $WS_ID..."

        # Default to Pictures folder
        START_DIR="$HOME/Pictures"
        if [ ! -d "$START_DIR" ]; then
            START_DIR="$HOME"
        fi

        IMAGE_PATH=$(gum file "$START_DIR" --height 15)

        if [ -n "$IMAGE_PATH" ]; then
            # Remove existing entry for this workspace
            grep -v "^${WS_ID}=" "$CONFIG_FILE" > "${CONFIG_FILE}.tmp"
            mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"

            # Add new entry
            echo "${WS_ID}=${IMAGE_PATH}" >> "$CONFIG_FILE"
            gum style --foreground 76 "✓ Set Workspace $WS_ID"
            sleep 0.5
        else
            gum style --foreground 220 "Skipped Workspace $WS_ID"
            sleep 0.5
        fi
    done

    gum style --foreground 76 "✓ Configuration complete for all workspaces"

    # Ask to reload
    if gum confirm "Reload configuration now?"; then
        reload_daemon
    fi
}

configure_workspace() {
    ACTION=$(gum choose "Single Workspace" "All Workspaces (Sequential)" "Back")

    case "$ACTION" in
        "Single Workspace")
            echo "Select Workspace ID:"
            WS_ID=$(gum input --placeholder "e.g., 1" --char-limit 2)

            if [ -z "$WS_ID" ]; then
                return
            fi

            # Check if integer
            if ! [[ "$WS_ID" =~ ^[0-9]+$ ]]; then
                gum style --foreground 196 "Invalid workspace ID"
                sleep 1
                return
            fi

            echo "Select Wallpaper Image:"
            # Default to Pictures folder
            START_DIR="$HOME/Pictures"
            if [ ! -d "$START_DIR" ]; then
                START_DIR="$HOME"
            fi

            IMAGE_PATH=$(gum file "$START_DIR" --height 15)

            if [ -z "$IMAGE_PATH" ]; then
                return
            fi

            # Remove existing entry for this workspace
            # create temp file
            grep -v "^${WS_ID}=" "$CONFIG_FILE" > "${CONFIG_FILE}.tmp"
            mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"

            # Add new entry
            echo "${WS_ID}=${IMAGE_PATH}" >> "$CONFIG_FILE"

            gum style --foreground 76 "✓ Configured Workspace $WS_ID"

            # Ask to reload
            if gum confirm "Reload configuration now?"; then
                reload_daemon
            fi
            ;;
        "All Workspaces (Sequential)")
            configure_all_workspaces
            ;;
        "Back")
            return
            ;;
    esac
}

configure_animations() {
    echo "Select Transition Type:"
    TYPE=$(gum choose "simple" "grow" "outer" "center" "any" "random" "wipe" "wave" "Blur (Preset)" --height 12)

    if [ -z "$TYPE" ]; then return; fi

    if [ "$TYPE" == "Blur (Preset)" ]; then
        # Special preset that mimics a blur feel using fade and bezier curves
        NEW_ARGS="--transition-type fade --transition-duration 1.0 --transition-fps 60 --transition-bezier 0.65,0,0.35,1"
    else
        echo "Enter Duration (seconds):"
        DURATION=$(gum input --placeholder "0.5" --value "0.5")

        echo "Enter FPS:"
        FPS=$(gum input --placeholder "60" --value "60")

        # Construct args
        # defaults: --transition-pos 0.5,0.5 --transition-step 90
        NEW_ARGS="--transition-type $TYPE --transition-duration $DURATION --transition-fps $FPS --transition-pos 0.5,0.5 --transition-step 90"
    fi

    # Save to config
    # Remove existing line if present
    grep -v "^TRANSITION_ARGS=" "$CONFIG_FILE" > "${CONFIG_FILE}.tmp"
    mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"

    echo "TRANSITION_ARGS=\"$NEW_ARGS\"" >> "$CONFIG_FILE"

    gum style --foreground 76 "✓ Animation settings saved"

    if gum confirm "Reload daemon to apply?"; then
        reload_daemon
    fi
}

view_config() {
    if [ ! -s "$CONFIG_FILE" ]; then
        gum style --italic "Configuration is empty"
    else
        echo "## Wallpapers"
        grep -v "^TRANSITION_ARGS=" "$CONFIG_FILE" | gum table --border normal --columns "Workspace,Path" --print

        echo ""
        echo "## Animation Settings"
        grep "^TRANSITION_ARGS=" "$CONFIG_FILE" | cut -d'=' -f2- | tr -d '"' || echo "Default"
    fi
    gum input --placeholder "Press Enter to return..." > /dev/null
}

configure_autostart() {
    AUTOSTART_FILE="$HOME/.config/hypr/autostart.conf"

    # Check current status
    if grep -q "omarchy-workspace-bg-daemon" "$AUTOSTART_FILE" 2>/dev/null; then
        CURRENT_STATUS="Enabled"
    else
        CURRENT_STATUS="Disabled"
    fi

    echo "Autostart is currently: $CURRENT_STATUS"
    ACTION=$(gum choose "Enable Autostart" "Disable Autostart" "Cancel")

    case "$ACTION" in
        "Enable Autostart")
            if [ "$CURRENT_STATUS" == "Enabled" ]; then
                gum style --foreground 196 "Already enabled!"
            else
                if [ ! -f "$AUTOSTART_FILE" ]; then
                    touch "$AUTOSTART_FILE"
                fi
                echo "" >> "$AUTOSTART_FILE"
                echo "# Omarchy Workspace Backgrounds" >> "$AUTOSTART_FILE"
                echo "exec-once = omarchy-workspace-bg-daemon" >> "$AUTOSTART_FILE"
                gum style --foreground 76 "✓ Enabled autostart"
            fi
            ;;
        "Disable Autostart")
            if [ "$CURRENT_STATUS" == "Disabled" ]; then
                gum style --foreground 196 "Already disabled!"
            else
                # Use sed to remove the lines
                sed -i '\|omarchy-workspace-bg-daemon|d' "$AUTOSTART_FILE"
                sed -i '\|# Omarchy Workspace Backgrounds|d' "$AUTOSTART_FILE"
                gum style --foreground 76 "✓ Disabled autostart"
            fi
            ;;
        "Cancel")
            return
            ;;
    esac
    sleep 1
}

# Main Loop
while true; do
    show_header

    CHOICE=$(gum choose "Configure Workspace Wallpaper" "Configure Animations" "Configure Autostart" "View Current Config" "Restart Daemon" "Stop Daemon" "Exit" --height 12 --header "Select an action")

    case "$CHOICE" in
        "Configure Workspace Wallpaper")
            configure_workspace
            ;;
        "Configure Animations")
            configure_animations
            ;;
        "Configure Autostart")
            configure_autostart
            ;;
        "View Current Config")
            view_config
            ;;
        "Restart Daemon")
            gum spin --spinner dot --title "Restarting daemon..." -- sleep 1
            pkill -f "$DAEMON_NAME"
            # Attempt to start it
            if command -v "$DAEMON_NAME" &> /dev/null; then
                setsid "$DAEMON_NAME" >/dev/null 2>&1 < /dev/null &
                gum style --foreground 76 "✓ Daemon started in background"
            else
                 SCRIPT_DIR=$(dirname "$(readlink -f "$0")")
                if [ -x "$SCRIPT_DIR/$DAEMON_NAME" ]; then
                    setsid "$SCRIPT_DIR/$DAEMON_NAME" >/dev/null 2>&1 < /dev/null &
                     gum style --foreground 76 "✓ Daemon started in background"
                else
                    gum style --foreground 196 "Could not find daemon script to start"
                fi
            fi
            sleep 1
            ;;
        "Stop Daemon")
            if pgrep -f "$DAEMON_NAME" > /dev/null; then
                pkill -f "$DAEMON_NAME"
                gum style --foreground 76 "✓ Daemon stopped"
            else
                gum style --foreground 196 "Daemon is not running"
            fi
            sleep 1
            ;;
        "Exit")
            clear
            exit 0
            ;;
    esac
done
