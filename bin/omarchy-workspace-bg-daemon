#!/bin/bash

# Configuration
CONFIG_DIR="$HOME/.config/omarchy/workspace-bg"
CONFIG_FILE="$CONFIG_DIR/config.conf"
# Fallback to omarchy default if available, otherwise just use a placeholder or nothing
DEFAULT_BG_LINK="$HOME/.config/omarchy/current/background"

# Default transition args (can be overridden by env vars if needed)
TRANSITION_ARGS="${TRANSITION_ARGS:-"--transition-type grow --transition-pos 0.5,0.5 --transition-fps 60 --transition-step 90 --transition-duration 0.5"}"

# Check dependencies
for cmd in swww socat jq; do
    if ! command -v $cmd &> /dev/null; then
        echo "Error: $cmd is required but not installed." >&2
        notify-send "Omarchy Workspace BG" "Error: $cmd not found"
        exit 1
    fi
done

# Ensure config directory exists
mkdir -p "$CONFIG_DIR"

# Resolve default background
DEFAULT_BG=""
if [ -L "$DEFAULT_BG_LINK" ]; then
    DEFAULT_BG=$(readlink -f "$DEFAULT_BG_LINK")
elif [ -f "$DEFAULT_BG_LINK" ]; then
    DEFAULT_BG="$DEFAULT_BG_LINK"
fi

# Kill conflicting wallpaper daemons (optional, maybe user wants to manage this manually, but for omarchy integration strictly:
pkill swaybg 2>/dev/null
pkill hyprpaper 2>/dev/null

# Check if swww-daemon is running, if not start it
if ! pgrep -x "swww-daemon" > /dev/null; then
    swww-daemon &
    sleep 0.5
fi

# Function to get wallpaper for workspace
get_wallpaper_for_workspace() {
    local ws=$1
    local bg=""

    if [ -f "$CONFIG_FILE" ]; then
        # Format: workspace_id=/path/to/image
        bg=$(grep "^${ws}=" "$CONFIG_FILE" | cut -d'=' -f2-)
    fi

    if [ -z "$bg" ] || [ ! -f "$bg" ]; then
        if [ -n "$DEFAULT_BG" ] && [ -f "$DEFAULT_BG" ]; then
            bg="$DEFAULT_BG"
        fi
    fi

    echo "$bg"
}

# Apply wallpaper for a specific workspace
apply_wallpaper() {
    local ws=$1
    local bg=$(get_wallpaper_for_workspace "$ws")

    if [ -n "$bg" ]; then
        swww img "$bg" $TRANSITION_ARGS
    fi
}

# Initial setup
CURRENT_WS=$(hyprctl activeworkspace -j | jq -r '.id')
apply_wallpaper "$CURRENT_WS"

# Handle arguments
if [ "$1" == "--reload" ]; then
    apply_wallpaper "$CURRENT_WS"
    exit 0
fi

# Monitor workspace changes
handle_socket_event() {
    local event=$1
    if [[ $event == "workspace>>"* ]]; then
        local new_ws=${event#*>>}
        apply_wallpaper "$new_ws"
    fi
}

# Listen to Hyprland socket
SOC_PATH="$XDG_RUNTIME_DIR/hypr/$HYPRLAND_INSTANCE_SIGNATURE/.socket2.sock"

if [ ! -S "$SOC_PATH" ]; then
    echo "Error: Hyprland socket not found at $SOC_PATH" >&2
    exit 1
fi

echo "Listening for workspace changes..."
socat -U - UNIX-CONNECT:"$SOC_PATH" | while read -r line; do
    handle_socket_event "$line"
done
