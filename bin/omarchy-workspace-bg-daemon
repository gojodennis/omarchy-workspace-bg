#!/bin/bash

# Configuration
CONFIG_DIR="$HOME/.config/omarchy/workspace-bg"
CONFIG_FILE="$CONFIG_DIR/config.conf"
# Fallback to omarchy default if available, otherwise just use a placeholder or nothing
DEFAULT_BG_LINK="$HOME/.config/omarchy/current/background"

# Default transition args (can be overridden by config or env vars)
DEFAULT_TRANSITION="--transition-type grow --transition-pos 0.5,0.5 --transition-fps 60 --transition-step 90 --transition-duration 0.5"

# Load transition args from config if present
if [ -f "$CONFIG_FILE" ]; then
    FILE_TRANSITION=$(grep "^TRANSITION_ARGS=" "$CONFIG_FILE" | cut -d'=' -f2- | tr -d '"' | tr -d "'")
fi

TRANSITION_ARGS="${TRANSITION_ARGS:-${FILE_TRANSITION:-$DEFAULT_TRANSITION}}"

# Check optional dependencies
HAS_MPVPAPER=false
if command -v mpvpaper &> /dev/null; then
    HAS_MPVPAPER=true
fi

# Ensure config directory exists
mkdir -p "$CONFIG_DIR"

# Resolve default background
DEFAULT_BG=""
if [ -L "$DEFAULT_BG_LINK" ]; then
    DEFAULT_BG=$(readlink -f "$DEFAULT_BG_LINK")
elif [ -f "$DEFAULT_BG_LINK" ]; then
    DEFAULT_BG="$DEFAULT_BG_LINK"
fi

# Kill conflicting wallpaper daemons (optional, maybe user wants to manage this manually, but for omarchy integration strictly:
pkill swaybg 2>/dev/null
pkill hyprpaper 2>/dev/null
# Note: we don't kill mpvpaper here because we might manage multiple instances of it

# Check if swww-daemon is running, if not start it
if ! pgrep -x "swww-daemon" > /dev/null; then
    swww-daemon &
    sleep 0.5
fi

# Helper to check if file is video
is_video() {
    local file="$1"
    # Basic mime type check or extension check
    if [[ "$file" =~ \.(mp4|webm|mkv|mov|avi)$ ]]; then
        return 0
    fi
    # Use file command for better accuracy if available
    if command -v file &> /dev/null; then
        if file --mime-type "$file" | grep -q "video/"; then
            return 0
        fi
    fi
    return 1
}

# Function to get wallpaper for workspace
get_wallpaper_for_workspace() {
    local ws=$1
    local bg=""

    if [ -f "$CONFIG_FILE" ]; then
        # Format: workspace_id=/path/to/image
        bg=$(grep "^${ws}=" "$CONFIG_FILE" | cut -d'=' -f2-)
    fi

    if [ -z "$bg" ] || [ ! -f "$bg" ]; then
        if [ -n "$DEFAULT_BG" ] && [ -f "$DEFAULT_BG" ]; then
            bg="$DEFAULT_BG"
        fi
    fi

    echo "$bg"
}

# Helper to find monitor for a workspace
get_monitor_for_workspace() {
    local ws=$1
    # Check if workspace is active and on which monitor
    # hyprctl workspaces lists all workspaces
    hyprctl workspaces -j | jq -r ".[] | select(.id == $ws) | .monitor"
}

# Helper to find all monitors
get_all_monitors() {
    hyprctl monitors -j | jq -r '.[].name'
}

# Apply wallpaper for a specific workspace
apply_wallpaper() {
    local ws=$1
    local bg=$(get_wallpaper_for_workspace "$ws")

    if [ -n "$bg" ]; then
        local mon=$(get_monitor_for_workspace "$ws")

        # If workspace is not currently active on any monitor (it's hidden/inactive),
        # we don't strictly need to do anything until it becomes visible.
        # But if it IS visible, we must update it.

        # Fallback: if we can't find monitor (maybe it's not created yet or logic failed),
        # try to apply to all or focused? No, stick to target if possible.

        # If no monitor found, maybe just use focused one if it's the current workspace
        if [ -z "$mon" ]; then
             local current_ws=$(hyprctl activeworkspace -j | jq -r '.id')
             if [ "$ws" == "$current_ws" ]; then
                 mon=$(hyprctl activeworkspace -j | jq -r '.monitor')
             fi
        fi

        if $HAS_MPVPAPER && is_video "$bg"; then
            # Video Wallpaper Logic
            if [ -n "$mon" ]; then
                # Kill any existing mpvpaper on this monitor
                # Use strict pattern matching to avoid killing unrelated processes
                # Pattern: mpvpaper ... <monitor_name> ...
                # pkill -f matches full command line.
                pkill -f "mpvpaper.*$mon" 2>/dev/null

                # Wait a tiny bit for cleanup
                sleep 0.1

                # Start new mpvpaper
                # We fork it so it runs in background
                # Using nohup to detach completely
                # Using verbose output for debugging if needed, but suppressed here
                nohup mpvpaper -o "no-audio loop" "$mon" "$bg" >/dev/null 2>&1 &
            fi
        else
            # Image Wallpaper Logic
            if [ -n "$mon" ]; then
                 pkill -f "mpvpaper.*$mon" 2>/dev/null
            fi

            swww img "$bg" $TRANSITION_ARGS

            # Run wallpaper-update hook if it exists
            if [ -x "$HOME/.config/omarchy/hooks/wallpaper-update" ]; then
                "$HOME/.config/omarchy/hooks/wallpaper-update" "$bg" &
            fi
        fi
    fi
}

# Initial setup
CURRENT_WS=$(hyprctl activeworkspace -j | jq -r '.id')
apply_wallpaper "$CURRENT_WS"

# Handle arguments
if [ "$1" == "--reload" ]; then
    apply_wallpaper "$CURRENT_WS"
    exit 0
fi

# Monitor workspace changes
handle_socket_event() {
    local event=$1
    if [[ $event == "workspace>>"* ]]; then
        local new_ws=${event#*>>}
        apply_wallpaper "$new_ws"
    fi
}

# Listen to Hyprland socket
SOC_PATH="$XDG_RUNTIME_DIR/hypr/$HYPRLAND_INSTANCE_SIGNATURE/.socket2.sock"

if [ ! -S "$SOC_PATH" ]; then
    echo "Error: Hyprland socket not found at $SOC_PATH" >&2
    exit 1
fi

echo "Listening for workspace changes..."
socat -U - UNIX-CONNECT:"$SOC_PATH" | while read -r line; do
    handle_socket_event "$line"
done
