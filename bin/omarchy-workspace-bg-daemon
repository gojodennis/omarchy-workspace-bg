#!/bin/bash

# Debug logging
LOG_FILE="/tmp/omarchy-bg-daemon.log"
exec 1>>"$LOG_FILE" 2>&1

# Singleton Check: Kill other instances of this script
SCRIPT_NAME=$(basename "$0")
for pid in $(pgrep -f "$SCRIPT_NAME"); do
    if [ "$pid" != "$$" ]; then
        echo "Killing existing instance: $pid"
        kill "$pid" 2>/dev/null
    fi
done

echo "--- Daemon started at $(date) with PID $$ ---"

# Configuration
CONFIG_DIR="$HOME/.config/omarchy/workspace-bg"
CONFIG_FILE="$CONFIG_DIR/config.conf"
# Fallback to omarchy default if available, otherwise just use a placeholder or nothing
DEFAULT_BG_LINK="$HOME/.config/omarchy/current/background"

# Default transition args (can be overridden by config or env vars)
DEFAULT_TRANSITION="--transition-type grow --transition-pos 0.5,0.5 --transition-fps 60 --transition-step 90 --transition-duration 0.5"

# Load transition args from config if present
if [ -f "$CONFIG_FILE" ]; then
    FILE_TRANSITION=$(grep "^TRANSITION_ARGS=" "$CONFIG_FILE" | cut -d'=' -f2- | tr -d '"' | tr -d "'")
    # Load slideshow interval (in minutes), default 10
    SLIDESHOW_INTERVAL=$(grep "^SLIDESHOW_INTERVAL=" "$CONFIG_FILE" | cut -d'=' -f2- | tr -d '"' | tr -d "'")
fi

TRANSITION_ARGS="${TRANSITION_ARGS:-${FILE_TRANSITION:-$DEFAULT_TRANSITION}}"
SLIDESHOW_INTERVAL="${SLIDESHOW_INTERVAL:-10}"
SLIDESHOW_SECONDS=$((SLIDESHOW_INTERVAL * 60))

# Check dependencies
for cmd in swww socat jq; do
    if ! command -v $cmd &> /dev/null; then
        echo "Error: $cmd is required but not installed."
        notify-send "Omarchy Workspace BG" "Error: $cmd not found"
        exit 1
    fi
done

# Check optional dependencies
HAS_MPVPAPER=false
if command -v mpvpaper &> /dev/null; then
    HAS_MPVPAPER=true
    echo "mpvpaper found, video support enabled"
else
    echo "mpvpaper not found, video support disabled"
fi

# Ensure config directory exists
mkdir -p "$CONFIG_DIR"

# Resolve default background
DEFAULT_BG=""
if [ -L "$DEFAULT_BG_LINK" ]; then
    DEFAULT_BG=$(readlink -f "$DEFAULT_BG_LINK")
elif [ -f "$DEFAULT_BG_LINK" ]; then
    DEFAULT_BG="$DEFAULT_BG_LINK"
fi
echo "Default BG: $DEFAULT_BG"

# Kill conflicting wallpaper daemons (optional, maybe user wants to manage this manually, but for omarchy integration strictly:
pkill swaybg 2>/dev/null
pkill hyprpaper 2>/dev/null
# Note: we don't kill mpvpaper here because we might manage multiple instances of it

# Check if swww-daemon is running, if not start it
if ! pgrep -x "swww-daemon" > /dev/null; then
    echo "Starting swww-daemon..."
    swww-daemon &
    sleep 0.5
fi

# Helper to check if file is video
is_video() {
    local file="$1"
    # Basic mime type check or extension check
    if [[ "$file" =~ \.(mp4|webm|mkv|mov|avi)$ ]]; then
        return 0
    fi
    # Use file command for better accuracy if available
    if command -v file &> /dev/null; then
        if file --mime-type "$file" | grep -q "video/"; then
            return 0
        fi
    fi
    return 1
}

# Function to get wallpaper for workspace
get_wallpaper_for_workspace() {
    local ws=$1
    local bg=""

    if [ -f "$CONFIG_FILE" ]; then
        # Format: workspace_id=/path/to/image
        bg=$(grep "^${ws}=" "$CONFIG_FILE" | cut -d'=' -f2-)
    fi

    # Folder Support: Pick random file if bg is a directory
    if [ -d "$bg" ]; then
        # Find images/videos (case insensitive extensions)
        # We assume standard image/video types supported by swww/mpvpaper
        local files=($(find -L "$bg" -maxdepth 1 -type f | grep -E -i "\.(jpe?g|png|gif|webp|bmp|mp4|webm|mkv|mov|avi)$"))
        local count=${#files[@]}

        if [ $count -gt 0 ]; then
            # Pick random index
            local index=$((RANDOM % count))
            bg="${files[$index]}"
            echo "  Selected random file from folder: $bg"
        else
            echo "  Warning: No valid media files found in directory $bg"
            bg=""
        fi
    fi

    if [ -z "$bg" ] || [ ! -f "$bg" ]; then
        if [ -n "$DEFAULT_BG" ] && [ -f "$DEFAULT_BG" ]; then
            bg="$DEFAULT_BG"
        fi
    fi

    echo "$bg"
}

# Helper to find monitor for a workspace
get_monitor_for_workspace() {
    local ws=$1
    # Check if workspace is active and on which monitor
    # hyprctl workspaces lists all workspaces
    # We use -r for raw output to avoid extra quotes if using jq -r
    hyprctl workspaces -j | jq -r ".[] | select(.id == $ws) | .monitor"
}

# Apply wallpaper for a specific workspace
apply_wallpaper() {
    local ws=$1
    echo "Applying wallpaper for Workspace $ws..."

    local bg=$(get_wallpaper_for_workspace "$ws")
    echo "  Target BG: $bg"

    if [ -n "$bg" ]; then
        local mon=$(get_monitor_for_workspace "$ws")
        echo "  Monitor: $mon"

        # If no monitor found, maybe just use focused one if it's the current workspace
        if [ -z "$mon" ]; then
             local current_ws=$(hyprctl activeworkspace -j | jq -r '.id')
             if [ "$ws" == "$current_ws" ]; then
                 mon=$(hyprctl activeworkspace -j | jq -r '.monitor')
                 echo "  Using focused monitor: $mon"
             fi
        fi

        if $HAS_MPVPAPER && is_video "$bg"; then
            echo "  Type: Video"
            # Video Wallpaper Logic
            if [ -n "$mon" ]; then
                # Always kill existing mpvpaper on this monitor first
                # This handles switching from video -> video as well
                echo "  Killing existing mpvpaper on $mon..."
                pkill -f "mpvpaper.*$mon" 2>/dev/null

                # Wait a tiny bit for cleanup to avoid race conditions
                sleep 0.2

                # Start new mpvpaper
                echo "  Starting mpvpaper..."
                # Using nohup to detach completely so it survives shell closures
                # Redirect output to prevent hang
                nohup mpvpaper -o "no-audio loop" "$mon" "$bg" >/dev/null 2>&1 &
                echo "  mpvpaper started with PID $!"
            else
                echo "  Error: No monitor found for video wallpaper"
            fi
        else
            echo "  Type: Image"
            # Image Wallpaper Logic
            if [ -n "$mon" ]; then
                 # Kill video wallpaper if we are switching to image
                 pkill -f "mpvpaper.*$mon" 2>/dev/null
            fi

            swww img "$bg" $TRANSITION_ARGS

            # Run wallpaper-update hook if it exists
            if [ -x "$HOME/.config/omarchy/hooks/wallpaper-update" ]; then
                echo "  Running hook..."
                "$HOME/.config/omarchy/hooks/wallpaper-update" "$bg" &
            fi
        fi
    else
        echo "  No wallpaper found."
    fi
}

# Initial setup
# Wait a moment for Omarchy to finish its startup (and theme restore)
sleep 2

# Ensure swaybg is dead (handling startup race conditions)
pkill swaybg 2>/dev/null

CURRENT_WS=$(hyprctl activeworkspace -j | jq -r '.id')
apply_wallpaper "$CURRENT_WS"

# Handle arguments
if [ "$1" == "--reload" ]; then
    apply_wallpaper "$CURRENT_WS"
    exit 0
fi

# Monitor workspace changes
handle_socket_event() {
    local event=$1
    if [[ $event == "workspace>>"* ]]; then
        local new_ws=${event#*>>}
        apply_wallpaper "$new_ws"
    fi
}

# Robust Hyprland Signature Detection
if [ -z "$HYPRLAND_INSTANCE_SIGNATURE" ]; then
    # Try to find the signature directory
    # We look for a directory in /run/user/$UID/hypr/ that contains a .socket2.sock
    # We take the most recent one
    POSSIBLE_SIG=$(ls -t "$XDG_RUNTIME_DIR/hypr/" | head -n 1)
    if [ -n "$POSSIBLE_SIG" ]; then
        export HYPRLAND_INSTANCE_SIGNATURE="$POSSIBLE_SIG"
        echo "Detected Hyprland Instance: $HYPRLAND_INSTANCE_SIGNATURE"
    fi
fi

# Determine Socket Path
SOC_PATH="$XDG_RUNTIME_DIR/hypr/$HYPRLAND_INSTANCE_SIGNATURE/.socket2.sock"

# Main Loop with Auto-Restart for socat and Socket Detection
echo "Starting main event loop..."
LAST_WALLPAPER_CHANGE=$(date +%s)

while true; do
    # Check for socket existence
    if [ ! -S "$SOC_PATH" ]; then
        echo "Socket not found at $SOC_PATH. Searching..."
        # Try to find it again
        POSSIBLE_SIG=$(ls -t "$XDG_RUNTIME_DIR/hypr/" 2>/dev/null | head -n 1)
        if [ -n "$POSSIBLE_SIG" ]; then
            export HYPRLAND_INSTANCE_SIGNATURE="$POSSIBLE_SIG"
            SOC_PATH="$XDG_RUNTIME_DIR/hypr/$HYPRLAND_INSTANCE_SIGNATURE/.socket2.sock"
        fi

        if [ ! -S "$SOC_PATH" ]; then
            echo "Still cannot find socket. Retrying in 3 seconds..."
            sleep 3
            continue
        fi
        echo "Found socket at $SOC_PATH"
    fi

    echo "Listening for events on $SOC_PATH..."

    # Use a file descriptor for reading from socat
    # We use process substitution to feed socat output into a file descriptor
    exec 3< <(socat -U - UNIX-CONNECT:"$SOC_PATH")

    while true; do
        # Read with timeout to allow slideshow checks
        # Timeout doesn't need to be 1s, can be larger, but 1s is responsive enough
        if read -r -t 1 -u 3 line; then
            # Got an event from Hyprland
            handle_socket_event "$line"
            # Update timestamp on workspace switch too, to reset slideshow timer
            if [[ "$line" == "workspace>>"* ]]; then
                LAST_WALLPAPER_CHANGE=$(date +%s)
            fi
        else
            # Check exit status of read
            # > 128 means timeout (normal), other non-zero means EOF (socket closed)
            EXIT_CODE=$?
            if [ $EXIT_CODE -ne 142 ] && [ $EXIT_CODE -ne 0 ]; then
                echo "Socket connection lost (EOF). Reconnecting..."
                break
            fi

            # Slideshow Check
            NOW=$(date +%s)
            ELAPSED=$((NOW - LAST_WALLPAPER_CHANGE))

            if [ $ELAPSED -ge $SLIDESHOW_SECONDS ]; then
                # Time to rotate?
                # We check if current workspace has a folder configured
                CURRENT_WS=$(hyprctl activeworkspace -j | jq -r '.id')

                # We need to know if it's a folder without re-reading everything
                # For simplicity, we just call apply_wallpaper, and let it decide
                # But we should only force update if it's a directory

                # Check config for this workspace
                BG_PATH=""
                if [ -f "$CONFIG_FILE" ]; then
                    BG_PATH=$(grep "^${CURRENT_WS}=" "$CONFIG_FILE" | cut -d'=' -f2-)
                fi

                if [ -d "$BG_PATH" ]; then
                    echo "Slideshow timer triggered for Workspace $CURRENT_WS"
                    apply_wallpaper "$CURRENT_WS"
                    LAST_WALLPAPER_CHANGE=$NOW
                fi
            fi
        fi
    done

    # Close file descriptor
    exec 3<&-

    echo "Retrying connection in 2 seconds..."
    sleep 2
done
